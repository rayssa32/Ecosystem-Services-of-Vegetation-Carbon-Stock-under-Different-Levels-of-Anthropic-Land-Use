# Analysis of Vegetation Carbon Stock Ecosystem Services

This repository contains the code and methodological description of the analytical stage of the research **‚ÄúVegetation Carbon Stock Ecosystem Services under Different Intensities of Anthropogenic Use‚Äù**.

The objective of this stage is to compare **GPP**, **NPP**, and **Biomass** in relation to different **land uses** identified through a **supervised classification** of Sentinel-2 images.  
The data were cross-referenced with MODIS products in TIFF format and analyzed using the script `modoA_analise_stats_v2.py`.

## 1. General description of the code

The script performs the **spatial intersection** between:

- **Land use and land cover raster** (Sentinel-2 classification / QGIS);
- **MODIS metric rasters** (GPP, NPP, and Biomass);
- **Municipality shapefile**.

### Main steps performed

1. **Cropping and reprojection** of the metric rasters to the CRS and grid of the class (land use) raster;
2. **Extraction of statistics** (mean, median, standard deviation, sum, and count) by class and municipality;
3. **Calculation of totals** (sum √ó pixel area);
4. **Inferential statistical tests** (ANOVA or Kruskal‚ÄìWallis, depending on assumptions);
5. **Post-hoc tests** (Tukey HSD or Dunn‚ÄìHolm);
6. **Calculation of effect sizes** (Œ∑¬≤ and Œµ¬≤);
7. **Generation of plots** with p-value and effect size annotations;
8. **Export** of results and plots by municipality and metric.



## 2. Main analytical functions

| Function | Description |
|----------|-------------|
| `_summarize_by_classes` | Calculates mean, median, std, sum, and count per class |
| `_sample_per_class` | Stratified random sampling per class (up to 5000 pixels) |
| `shapiro` | Normality test (per group) |
| `levene` | Homogeneity of variances test |
| `f_oneway` | One-way ANOVA (if normality + homoscedasticity are satisfied) |
| `kruskal` | Kruskal‚ÄìWallis test (if assumptions are not met) |
| `pairwise_tukeyhsd` | Tukey HSD post-hoc (for ANOVA) |
| `posthoc_dunn` | Dunn post-hoc with Holm adjustment (for Kruskal) |
| `_effect_sizes_anova` | Calculates Œ∑¬≤ (ANOVA) |
| `_effect_size_kruskal` | Calculates Œµ¬≤ (Kruskal) |
| `_barplot_with_annotation` | Generates bar plot (mean ¬± std) with p-value and effect annotations |
| `WarpedVRT` | Reprojects MODIS rasters to the CRS of the class raster |
| `gdf.to_crs()` | Reprojects the municipality shapefile to the CRS of the class raster |



## 3. CRS correction

The **class raster (Sentinel)** is the **coordinate system reference**.  
The code **does not reproject** this raster internally ‚Äî it must already be **in a projected CRS (meters)** before execution.

Other corrections are done automatically:
- **MODIS rasters:** reprojected with `WarpedVRT` to the CRS/transform of the class raster;
- **Municipality shapefile:** reprojected with `gdf.to_crs(src_class.crs)`.

> üî∏ If the class raster is not in a projected CRS, the script will throw an error.


## 4. Plots and visualizations

### Plots generated by the code
- **Bar plots (mean ¬± standard deviation)** with legend including:
  - test type (ANOVA or Kruskal);
  - global p-value;
  - effect size (Œ∑¬≤ or Œµ¬≤).

### Limitations
- They hide the **full distribution** of the data (skewness and outliers);
- Use of standard deviation may be replaced by standard error of the mean (SEM);
- May not adequately represent non-normal metrics.

### Recommended plots
| Objective | Suggested plot |
|-----------|----------------|
| Compare classes | **Boxplot** or **Violin plot** (with jittered points) |
| Visualize correlation between metrics | **Scatter plot** (with regression and R¬≤) |
| Compare multiple metrics | **Heatmap** or **Faceted boxplots** |
| Highlight significant differences | **Boxplot with grouping letters** (a/b/c) from post-hoc |


## 5. Statistical methods used

### Assumption diagnostics
- **Normality:** `shapiro`
- **Homoscedasticity:** `levene (center='median')`

### Main tests
- **One-way ANOVA:** `f_oneway`
- **Kruskal‚ÄìWallis:** `kruskal`

### Post-hoc
- **Tukey HSD:** `pairwise_tukeyhsd`  
- **Dunn‚ÄìHolm:** `scikit_posthocs.posthoc_dunn(method='holm')`

### Effect sizes
- **Œ∑¬≤ (eta squared):** measure of effect magnitude (ANOVA)  
- **Œµ¬≤ (epsilon squared):** approximate measure (Kruskal)



## 6. Reliability of results

The applied tests are **statistically appropriate** for comparing metrics between classes, **as long as**:

- Sampled data represent independent observations;
- Units and scales (GPP, NPP, Biomass) are compatible;
- CRS and spatial resolution are correctly aligned.

### Factors that may affect reliability
1. **Spatial autocorrelation:** nearby pixels are not independent.  
   - Solution: calculate Moran‚Äôs I, aggregate by patch, or use spatial models.
2. **Pixel-level sampling:** may overestimate test power.
3. **Units:** confirm original units (gC/m¬≤, Mg/ha, etc.) before interpreting totals.
4. **Multiple testing across cities:** adjust p-values (Bonferroni/FDR) if multiple comparisons are made.



## 7. Types of reliability and test justification

| Test / Procedure | Purpose | Requirement |
|------------------|---------|-------------|
| **Shapiro** | Checks normality of groups | Necessary (for ANOVA) |
| **Levene** | Checks homogeneity of variances | Necessary (for ANOVA) |
| **ANOVA** | Compares means (parametric) | Appropriate if assumptions are valid |
| **Kruskal‚ÄìWallis** | Compares medians (non-parametric) | Robust alternative |
| **Tukey / Dunn** | Identifies pairwise differences | Essential for interpretation |
| **Œ∑¬≤ / Œµ¬≤** | Measures effect magnitude | Strongly recommended |



## 8. Practical recommendations

1. **Ensure projected CRS** for the classification raster (in meters);
2. **Verify units** of GPP/NPP/Biomass before interpreting totals;
3. **Complement bar plots** with boxplots or violin plots;
4. **Test spatial autocorrelation** (Moran‚Äôs I);
5. **Aggregate by patch** to reduce spatial dependence;
6. Use **hierarchical models (GLMMs)** if comparing all cities simultaneously;
7. **Report 95% CI and effect sizes** in results.




## 9. Suggested extensions

- [ ] Replace `_barplot_with_annotation` with a function that generates **boxplots + points + post-hoc letters**  
- [ ] Add **Moran‚Äôs I** calculation per municipality  
- [ ] Create **scatter plots** (GPP √ó NPP √ó Biomass) with Pearson and Spearman correlations  
- [ ] Implement **multiple testing correction** between municipalities  
- [ ] Allow **mixed linear models** (city as a random effect)



## 10. Outputs generated
   - `./dados_gerados/<City>_stats_por_classe.csv`  
   - `./dados_gerados/todas_cidades_stats_por_classe.csv`  
   - `./dados_gerados/stats/resumo_inferencial_por_cidade.csv`  
   - PNG plots per city and metric, with significance annotation.


## Recommended structure

For organization and future testing, the ideal modular structure would be:

```
geostats_mode_a/
‚îú‚îÄ config.py
‚îú‚îÄ io.py
‚îú‚îÄ sampling.py
‚îú‚îÄ infer.py
‚îú‚îÄ plots.py
‚îú‚îÄ pipeline.py
‚îî‚îÄ cli.py
```


> The current `main.py` already contains all consolidated logic. Modularization is optional.



## Requirements

### Language
- Python **3.10+**

### Libraries
- `numpy`
- `pandas`
- `rasterio`
- `geopandas`
- `shapely`
- `affine`
- `scipy`
- `statsmodels`
- `scikit-posthocs`
- `matplotlib`

## Installation

Install all dependencies globally for your user:

```bash
pip install --user numpy pandas rasterio geopandas shapely affine scipy statsmodels scikit-posthocs matplotlib
```



## How to Run

1. **Adjust the paths at the beginning of the `main.py`:**

   ```python
   class_raster_path = "classificacao/no_clouds2.tif"
   metrics_rasters = {
       "GPP": "metricas/GPP_sete_cidades.tif",
       "NPP": "metricas/NPP_sete_cidades.tif",
       "Biomassa": "metricas/Biomass_sete_cidades.tif",
   }
   vector_cities_path = "shapefile/sete_cidades.shp"
   city_field = "NM_MUN"
   class_map = {1: "Vegeta√ß√£o", 2: "Urbano", 3: "√Ågua", 4: "Solo"}
   ```

2. **(Optional) Configure the global parameters at the top:**

   * `RESAMPLE_METRICS = "nearest"`
   * `MAKE_PLOTS = True`
   * `RUN_INFERENTIAL_TESTS = True`
   * `EXCLUDE_CLASSES = [5]`
   * `SAMPLE_PER_CLASS = 5000`
   * `ALPHA = 0.05`

3. **Run the script:**

   ```bash
   python main.py
   ```

4. **Check the outputs in the folder `dados_gerados/`.**



## Interpretation of Results

| Output type                                                                           | Description                                                   |
|---------------------------------------------------------------------------------------|---------------------------------------------------------------|
| `*_stats_por_classe.csv`                                                              | Descriptive statistics by class and metric.                   |
| `todas_cidades_stats_por_classe.csv`                                                  | All cities combined.                                          |
| `resumo_inferencial_por_cidade.csv`                                                   | Summary: city, metric, global test, p-value, effect size.     |
| `pairwise_<city>_<metric>_tukey.csv` / `pairwise_<city>_<metric>_dunn_holm.csv`       | Pairwise comparisons (post-hoc).                              |
| PNG plots                                                                             | Means per class with annotation box (test/p/effect).          |


**Annotation in the plot:**

```
ANOVA
p = 0.034   Œ∑¬≤ = 0.62   ‚òÖ
```


> The star `‚òÖ` indicates significance (p < 0.05).  
> Œ∑¬≤ is the effect size for ANOVA, Œµ¬≤ for Kruskal‚ÄìWallis.

---

## Troubleshooting Tips

| Problem                                 | Likely cause                          | Solution                                 |
|-----------------------------------------|----------------------------------------|-------------------------------------------|
| `ValueError: geometries do not overlap` | Polygon outside raster extent          | Check CRS and data extent                 |
| Empty CSVs                              | Class with no valid pixels             | Confirm `nodata` and mask                 |
| Plots without bars                      | `MAKE_PLOTS=False` or missing data     | Enable flag and review rasters            |
| ImportError (rasterio/geopandas)        | Missing GDAL/Fiona libraries           | Install via conda-forge                   |
| P-values = NaN                          | Small classes (<10 samples)            | Increase `MIN_N_FOR_TESTS` or expand area |

---

## Statistical References

- **Field, A. (2018)**. *Discovering Statistics Using R.* SAGE.  
- **Zar, J. H. (2010)**. *Biostatistical Analysis.* Pearson.  
- **Legendre & Fortin (1989)**. *Spatial pattern and ecological analysis.* Vegetatio.  
- **Goslee & Urban (2007)**. *The ecodist package for dissimilarity-based analysis of ecological data.* Journal of Statistical Software.



## Script Author/co-author

**Rayssa de Oliveira Dias and Luiz Felipe S√°**
 ---

 
## License

This project is shared under the **Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 License (CC BY-NC-ND 4.0)**.

You may copy and redistribute the script with proper attribution, but commercial use and modification are prohibited without permission. See the `LICENSE` file for details.

> Note: This workflow is part of an active research project. The repository is temporarily licensed under supervisory rights due to an ongoing publication process. License terms may change upon official publication.

---
 


